<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restaurant Management</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>ğŸ½ï¸ Restaurant Dashboard</h1>
    <button id="theme-toggle" aria-label="Toggle Dark Mode">ğŸŒ™</button>
  </header>

  <main class="grid">

    <section class="card" id="create-order">
      <h2>ğŸ“ Create Order</h2>
      <form id="order-form">
        <label for="table">Table Number:</label>
        <input type="number" id="table" name="table" required>
        
        <label for="items">Items (comma-separated):</label>
        <input type="text" id="items" name="items" required>
        
        <button type="submit">Create Order</button>
      </form>
      <p id="order-message"></p>
    </section>

    <section class="card" id="orders">
      <h2>ğŸ§¾ Orders</h2>
      <ul id="orders-list">
        <li>Loading...</li>
      </ul>
    </section>

    <section class="card" id="kitchen">
      <h2>ğŸ‘¨â€ğŸ³ Kitchen</h2>
      <ul id="kitchen-list">
        <li>Loading...</li>
      </ul>
    </section>

    <section class="card" id="payments">
      <h2>ğŸ’³ Payments</h2>
      <ul id="payments-list">
        <li>Loading...</li>
      </ul>
    </section>

  </main>

  <footer>
    <p>&copy; 2025 Restaurant Management System</p>
  </footer>

  <script>
    async function fetchData(endpoint, listId, formatter) {
      try {
        const response = await fetch(endpoint);
        const data = await response.json();
        const list = document.getElementById(listId);
        list.innerHTML = ""; // Clear previous content
  
        data.forEach(item => {
          const li = document.createElement("li");
          li.innerHTML = formatter(item);
  
          // Add "Pay" button for pending payments
          if (listId === "payments-list" && item.paid === 0) {
            const payButton = document.createElement("button");
            payButton.textContent = "ğŸ’³ Pay";
            payButton.classList.add("pay-button");
            payButton.addEventListener("click", () => payPayment(item.table));
            li.appendChild(payButton);
          }
  
          list.appendChild(li);
        });
  
      } catch (error) {
        console.error("Error getting data", error);
        document.getElementById(listId).innerHTML = "<li>Error loading data</li>";
      }
    }
  
    async function payPayment(table) {
      try {
        const response = await fetch(`http://localhost:5003/payments/${table}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ paid: 1 })
        });
  
        if (response.ok) {
          // Refreshes after 21sec cause payments are done in 20
          setTimeout(loadAll, 21000);
        } else {
          alert("Failed to mark payment as Paid.");
        }
      } catch (error) {
        console.error("Error updating payment:", error);
        alert("Error updating payment.");
      }
    }
  
    function loadAll() {
      fetchData("http://localhost:5000/orders", "orders-list", item =>
        `Order #${item.id} - Table ${item.table} - ${item.items.join(", ")}`
      );
  
      fetchData("http://localhost:5000/kitchen", "kitchen-list", item =>
        `Order #${item.id} - Table ${item.table} - ${item.status}`
      );
  
      fetchData("http://localhost:5000/payments", "payments-list", item =>
        `Table #${item.table} - ${item.paid === 1 ? "Paid âœ…" : "Pending ğŸ’°"}`
      );
    }
  
    // Load everything one time only at the start
    loadAll();
  
    // Dark Mode Toggle
    const themeToggle = document.getElementById("theme-toggle");
    const body = document.body;
  
    themeToggle.addEventListener("click", () => {
      body.classList.toggle("dark-mode");
      const isDarkMode = body.classList.contains("dark-mode");
      themeToggle.textContent = isDarkMode ? "â˜€ï¸" : "ğŸŒ™";
    });
  
    // Handle order creation
    const orderForm = document.getElementById("order-form");
    const orderMessage = document.getElementById("order-message");
  
    orderForm.addEventListener("submit", async (event) => {
      event.preventDefault();
  
      const table = document.getElementById("table").value;
      const items = document.getElementById("items").value.split(",").map(item => item.trim());
  
      const orderData = {
        table: parseInt(table, 10),
        items: items
      };
  
      try {
        const response = await fetch("http://localhost:5000/orders", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(orderData)
        });
  
        if (response.ok) {
          const newOrder = await response.json();
          orderMessage.textContent = `Order #${newOrder.order.id} created successfully!`;
          orderMessage.style.color = "green";
          loadAll();
        } else {
          orderMessage.textContent = "Failed to create order.";
          orderMessage.style.color = "red";
        }
      } catch (error) {
        console.error("Error creating order:", error);
        orderMessage.textContent = "Error creating order.";
        orderMessage.style.color = "red";
      }
  
      orderForm.reset();
    });
  </script>  
</body>
</html>
